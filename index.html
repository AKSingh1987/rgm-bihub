import React, { useMemo, useState } from "react";
import { motion } from "framer-motion";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Sheet, SheetContent, SheetFooter, SheetHeader, SheetTitle, SheetTrigger } from "@/components/ui/sheet";
import { Label } from "@/components/ui/label";
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from "recharts";
import { Filter, RefreshCcw, Settings, Download, CheckCircle2, AlertCircle, Clock, Plus } from "lucide-react";

// --- Mock Data (replace with live AAS / XMLA results) ---
const seedRows = [
  { id: 1, model: "NRM_Global", partition: "US_Snacks", type: "Scheduled", start: "2025-09-17T07:20:00", end: "2025-09-17T07:36:10", status: "Success", requestedBy: "system", priority: "Medium", notes: "Daily 7:20" },
  { id: 2, model: "NRM_Global", partition: "IN_Bev", type: "Adhoc", start: "2025-09-17T08:03:00", end: "2025-09-17T08:25:30", status: "Success", requestedBy: "amit.singh", priority: "High", notes: "Promo check" },
  { id: 3, model: "NRM_Global", partition: "BR_Snacks", type: "Scheduled", start: "2025-09-17T09:00:00", end: "2025-09-17T09:41:40", status: "Failed", requestedBy: "system", priority: "Medium", notes: "Timeout" },
  { id: 4, model: "Elasticity_APAC", partition: "TH_Bev", type: "New", start: "2025-09-17T06:10:00", end: "2025-09-17T06:28:40", status: "Success", requestedBy: "onboarding-bot", priority: "Low", notes: "Initial load" },
  { id: 5, model: "Elasticity_APAC", partition: "PH_Bev", type: "Adhoc", start: "2025-09-17T10:12:00", end: "2025-09-17T10:44:30", status: "In Progress", requestedBy: "analyst.kim", priority: "Medium", notes: "Investigate spike" },
  { id: 6, model: "PostEvent_LATAM", partition: "MX_Snacks", type: "Scheduled", start: "2025-09-17T05:40:00", end: "2025-09-17T06:05:00", status: "Success", requestedBy: "system", priority: "Low", notes: "Nightly" },
  { id: 7, model: "PostEvent_LATAM", partition: "AR_Bev", type: "Scheduled", start: "2025-09-17T06:30:00", end: "2025-09-17T06:55:00", status: "Success", requestedBy: "system", priority: "Low", notes: "Nightly" },
  { id: 8, model: "NRM_Global", partition: "UK_Snacks", type: "Adhoc", start: "2025-09-17T11:05:00", end: "2025-09-17T11:38:10", status: "In Progress", requestedBy: "ops.lee", priority: "High", notes: "QBR" },
];

function minutesSinceStartOfDay(dateStr) {
  const d = new Date(dateStr);
  return d.getHours() * 60 + d.getMinutes() + d.getSeconds() / 60;
}

function durationMinutes(startStr, endStr) {
  const s = new Date(startStr).getTime();
  const e = endStr ? new Date(endStr).getTime() : s;
  return Math.max(0, (e - s) / 60000);
}

function formatHM(ms) {
  const m = Math.floor(ms);
  const s = Math.round((ms - m) * 60);
  const mm = String(m).padStart(2, "0");
  const ss = String(s).padStart(2, "0");
  return `${mm}:${ss}`;
}

function StatusBadge({ status }) {
  const map = {
    Success: { class: "bg-green-100 text-green-700 border-green-200", icon: <CheckCircle2 className="h-3.5 w-3.5" /> },
    Failed: { class: "bg-red-100 text-red-700 border-red-200", icon: <AlertCircle className="h-3.5 w-3.5" /> },
    "In Progress": { class: "bg-yellow-100 text-yellow-700 border-yellow-200", icon: <Clock className="h-3.5 w-3.5" /> },
    Queued: { class: "bg-blue-100 text-blue-700 border-blue-200", icon: <Clock className="h-3.5 w-3.5" /> },
    Submitted: { class: "bg-indigo-100 text-indigo-700 border-indigo-200", icon: <Clock className="h-3.5 w-3.5" /> },
  };
  const cfg = map[status] || { class: "bg-gray-100 text-gray-700 border-gray-200" };
  return (
    <Badge variant="outline" className={`gap-1 border ${cfg.class}`}>
      {cfg.icon} {status}
    </Badge>
  );
}

function kpiCard(title, value, sub) {
  return (
    <Card className="rounded-2xl shadow-sm">
      <CardHeader className="pb-2">
        <CardTitle className="text-sm text-muted-foreground">{title}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="text-3xl font-semibold">{value}</div>
        {sub && <div className="text-xs text-muted-foreground mt-1">{sub}</div>}
      </CardContent>
    </Card>
  );
}

export default function Dashboard() {
  const [rows, setRows] = useState(seedRows);
  const [q, setQ] = useState("");
  const [model, setModel] = useState("all");
  const [partition, setPartition] = useState("all");
  const [status, setStatus] = useState("all");
  const [rtype, setRtype] = useState("all");

  // New/Adhoc request form state
  const [form, setForm] = useState({
    type: "Adhoc",
    model: "",
    partition: "",
    priority: "Medium",
    requestedBy: "",
    notes: "",
  });

  const models = useMemo(() => Array.from(new Set(rows.map(r => r.model))), [rows]);
  const partitions = useMemo(() => Array.from(new Set(rows.map(r => r.partition))), [rows]);

  const filtered = useMemo(() => {
    return rows.filter(r => {
      const text = `${r.model} ${r.partition} ${r.type} ${r.status} ${r.requestedBy}`.toLowerCase();
      if (q && !text.includes(q.toLowerCase())) return false;
      if (model !== "all" && r.model !== model) return false;
      if (partition !== "all" && r.partition !== partition) return false;
      if (status !== "all" && r.status !== status) return false;
      if (rtype !== "all" && r.type !== rtype) return false;
      return true;
    }).map(r => ({
      ...r,
      startM: minutesSinceStartOfDay(r.start),
      durM: durationMinutes(r.start, r.end),
    }));
  }, [rows, q, model, partition, status, rtype]);

  const kpis = useMemo(() => {
    const total = filtered.length;
    const pendingAdhoc = filtered.filter(r => r.type === "Adhoc" && r.status !== "Success").length;
    const scheduledDone = filtered.filter(r => r.type === "Scheduled" && r.status === "Success").length;
    const failed = filtered.filter(r => r.status === "Failed").length;
    return { total, pendingAdhoc, scheduledDone, failed };
  }, [filtered]);

  const timelineData = useMemo(() => {
    return filtered.map(r => ({
      id: r.id,
      partition: r.partition,
      offset: r.startM,
      duration: r.durM,
      status: r.status,
    }));
  }, [filtered]);

  const statusColor = (s) => (s === "Success" ? "#22c55e" : s === "Failed" ? "#ef4444" : s === "Queued" ? "#3b82f6" : s === "Submitted" ? "#6366f1" : "#f59e0b");

  function submitRequest() {
    if (!form.model || !form.partition || !form.requestedBy) return alert("Please fill Model, Partition, and Requested By");
    const now = new Date();
    const newRow = {
      id: Date.now(),
      model: form.model,
      partition: form.partition,
      type: form.type, // "Adhoc" | "New"
      start: now.toISOString(),
      end: undefined, // not finished yet
      status: form.type === "Adhoc" ? "Queued" : "Submitted",
      requestedBy: form.requestedBy,
      priority: form.priority,
      notes: form.notes,
    };
    setRows(prev => [newRow, ...prev]);
    // reset
    setForm({ type: "Adhoc", model: "", partition: "", priority: "Medium", requestedBy: "", notes: "" });
    // close sheet by simulating click on document (consumer can wire controlled open if needed)
    const active = document.activeElement;
    if (active) (active).blur();
    alert(`${newRow.type} request submitted`);
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-slate-50">
      {/* Header */}
      <div className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <div className="h-9 w-9 rounded-xl bg-blue-600 flex items-center justify-center text-white font-bold">NRM</div>
          <div className="font-semibold text-lg">AAS Refresh Monitor</div>
          <div className="ml-auto flex items-center gap-2">
            {/* Submit Request Sheet */}
            <Sheet>
              <SheetTrigger asChild>
                <Button size="sm" className="rounded-xl gap-2"><Plus className="h-4 w-4"/> Submit Request</Button>
              </SheetTrigger>
              <SheetContent className="sm:max-w-md">
                <SheetHeader>
                  <SheetTitle>New / Adhoc Request</SheetTitle>
                </SheetHeader>
                <div className="grid gap-4 py-4">
                  <div className="grid gap-2">
                    <Label>Request Type</Label>
                    <Select value={form.type} onValueChange={(v)=>setForm(prev=>({...prev, type: v }))}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Type"/></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="Adhoc">Adhoc</SelectItem>
                        <SelectItem value="New">New</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-2">
                    <Label>Model</Label>
                    <Input value={form.model} onChange={(e)=>setForm(prev=>({...prev, model: e.target.value }))} placeholder="e.g., NRM_Global" />
                    <div className="text-xs text-muted-foreground">Known models: {models.join(", ") || "—"}</div>
                  </div>
                  <div className="grid gap-2">
                    <Label>Market / Partition</Label>
                    <Input value={form.partition} onChange={(e)=>setForm(prev=>({...prev, partition: e.target.value }))} placeholder="e.g., IN_Bev" />
                    <div className="text-xs text-muted-foreground">Examples: {partitions.slice(0,6).join(", ")}{partitions.length>6?"…":""}</div>
                  </div>
                  <div className="grid gap-2">
                    <Label>Priority</Label>
                    <Select value={form.priority} onValueChange={(v)=>setForm(prev=>({...prev, priority: v }))}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Priority"/></SelectTrigger>
                      <SelectContent>
                        {['Low','Medium','High'].map(p=> <SelectItem key={p} value={p}>{p}</SelectItem>)}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-2">
                    <Label>Requested By</Label>
                    <Input value={form.requestedBy} onChange={(e)=>setForm(prev=>({...prev, requestedBy: e.target.value }))} placeholder="name or email" />
                  </div>
                  <div className="grid gap-2">
                    <Label>Notes</Label>
                    <Input value={form.notes} onChange={(e)=>setForm(prev=>({...prev, notes: e.target.value }))} placeholder="purpose, ticket id, etc." />
                  </div>
                </div>
                <SheetFooter>
                  <Button className="rounded-xl" onClick={submitRequest}>Submit</Button>
                </SheetFooter>
              </SheetContent>
            </Sheet>

            {/* Connect / Export / Refresh */}
            <Sheet>
              <SheetTrigger asChild>
                <Button variant="outline" size="sm" className="rounded-xl gap-2"><Settings className="h-4 w-4"/> Connect</Button>
              </SheetTrigger>
              <SheetContent className="sm:max-w-md">
                <SheetHeader>
                  <SheetTitle>Connect to AAS / XMLA</SheetTitle>
                </SheetHeader>
                <div className="grid gap-4 py-4">
                  <div className="grid gap-2">
                    <Label htmlFor="server">Server URL</Label>
                    <Input id="server" placeholder="asazure://westus2.asazure.windows.net/your-server" />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="db">Database (Model)</Label>
                    <Input id="db" placeholder="NRM_Global" />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="token">Access Token (Service Principal)</Label>
                    <Input id="token" placeholder="aad-access-token" />
                  </div>
                </div>
                <SheetFooter>
                  <Button className="rounded-xl">Save & Test</Button>
                </SheetFooter>
              </SheetContent>
            </Sheet>
            <Button variant="outline" size="sm" className="rounded-xl gap-2"><Download className="h-4 w-4"/> Export CSV</Button>
            <Button size="sm" className="rounded-xl gap-2"><RefreshCcw className="h-4 w-4"/> Refresh</Button>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6">
        {/* Tabs */}
        <Tabs defaultValue="all">
          <TabsList className="rounded-2xl">
            <TabsTrigger value="all">All</TabsTrigger>
            <TabsTrigger value="adhoc">Adhoc Requests</TabsTrigger>
            <TabsTrigger value="new">New Requests</TabsTrigger>
            <TabsTrigger value="scheduled">Scheduled Refreshes</TabsTrigger>
          </TabsList>

          <TabsContent value="all" className="space-y-6">
            {/* KPIs */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {kpiCard("Total Items", kpis.total)}
              {kpiCard("Pending Adhoc", kpis.pendingAdhoc)}
              {kpiCard("Scheduled Done", kpis.scheduledDone)}
              {kpiCard("Failed", kpis.failed)}
            </div>

            {/* Filters */}
            <Card className="rounded-2xl">
              <CardContent className="pt-6">
                <div className="flex flex-col md:flex-row gap-3 items-stretch">
                  <div className="flex-1"><Input value={q} onChange={e=>setQ(e.target.value)} placeholder="Search model / partition / user" className="rounded-xl"/></div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <Select value={model} onValueChange={setModel}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Model"/></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Models</SelectItem>
                        {models.map(m => <SelectItem key={m} value={m}>{m}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Select value={partition} onValueChange={setPartition}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Partition"/></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Partitions</SelectItem>
                        {partitions.map(p => <SelectItem key={p} value={p}>{p}</SelectItem>)}
                      </SelectContent>
                    </Select>
                    <Select value={status} onValueChange={setStatus}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Status"/></SelectTrigger>
                      <SelectContent>
                        {['all','Success','Failed','In Progress','Queued','Submitted'].map(s=> (
                          <SelectItem key={s} value={s}>{s}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <Select value={rtype} onValueChange={setRtype}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Type"/></SelectTrigger>
                      <SelectContent>
                        {['all','Adhoc','Scheduled','New'].map(t=> (
                          <SelectItem key={t} value={t}>{t}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Timeline */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle className="flex items-center gap-2"><Filter className="h-4 w-4"/> Refresh Timeline (Start–End today)</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-80">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={timelineData} layout="vertical" margin={{ left: 80, right: 20, top: 10, bottom: 10 }}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis type="number" domain={[0, 24*60]} tickFormatter={(v) => `${Math.floor(v/60)}:${String(Math.floor(v%60)).padStart(2,'0')}`} />
                      <YAxis type="category" dataKey="partition" width={100} />
                      <Tooltip formatter={(value, name) => {
                        if (name === 'duration') return [`${Math.round(value)} min`, 'Duration'];
                        return [Math.round(value), name];
                      }} labelFormatter={(v)=>`Start ${Math.floor(v/60)}:${String(Math.floor(v%60)).padStart(2,'0')}`} />
                      {/* Invisible offset to create a left margin equal to start time */}
                      <Bar dataKey="offset" stackId="a" fill="transparent" />
                      <Bar dataKey="duration" stackId="a" radius={[6,6,6,6]} fill={(d)=>statusColor(d?.payload?.status)} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>

            {/* Table */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Refresh Status by Model & Partition</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="overflow-auto">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Model</TableHead>
                        <TableHead>Market / Partition</TableHead>
                        <TableHead>Type</TableHead>
                        <TableHead>Start</TableHead>
                        <TableHead>End</TableHead>
                        <TableHead>Duration</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead>Requested By</TableHead>
                        <TableHead>Priority</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {filtered.map(r => (
                        <TableRow key={r.id} className="hover:bg-slate-50">
                          <TableCell className="font-medium">{r.model}</TableCell>
                          <TableCell>{r.partition}</TableCell>
                          <TableCell>
                            <Badge variant="secondary" className="rounded-xl">{r.type}</Badge>
                          </TableCell>
                          <TableCell>{new Date(r.start).toLocaleTimeString()}</TableCell>
                          <TableCell>{r.end ? new Date(r.end).toLocaleTimeString() : '—'}</TableCell>
                          <TableCell>{formatHM(r.durM)}</TableCell>
                          <TableCell><StatusBadge status={r.status}/></TableCell>
                          <TableCell>{r.requestedBy}</TableCell>
                          <TableCell>{r.priority || '—'}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Focused tabs - simple filtered views */}
          <TabsContent value="adhoc">
            <FilteredBlock title="Adhoc Requests" filter={{ type: "Adhoc" }} rows={rows} />
          </TabsContent>
          <TabsContent value="new">
            <FilteredBlock title="New Requests" filter={{ type: "New" }} rows={rows} />
          </TabsContent>
          <TabsContent value="scheduled">
            <FilteredBlock title="Scheduled Refreshes" filter={{ type: "Scheduled" }} rows={rows} />
          </TabsContent>
        </Tabs>
      </div>

      {/* Subtle enter animation */}
      <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ duration: 0.4 }} />
    </div>
  );
}

function FilteredBlock({ title, filter, rows }) {
  const [q, setQ] = useState("");
  const view = useMemo(() => rows.filter(r => {
    if (filter?.type && r.type !== filter.type) return false;
    if (q && !(r.model + r.partition).toLowerCase().includes(q.toLowerCase())) return false;
    return true;
  }).map(r => ({
    ...r,
    startM: minutesSinceStartOfDay(r.start),
    durM: durationMinutes(r.start, r.end),
  })), [q, filter, rows]);

  const done = view.filter(r => r.status === 'Success').length;
  const failed = view.filter(r => r.status === 'Failed').length;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h3 className="text-xl font-semibold">{title}</h3>
        <Input value={q} onChange={e=>setQ(e.target.value)} placeholder="Search" className="rounded-xl max-w-xs"/>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {kpiCard("Items", view.length)}
        {kpiCard("Done", done)}
        {kpiCard("Failed", failed)}
      </div>

      <Card className="rounded-2xl">
        <CardContent className="pt-6">
          <div className="overflow-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Model</TableHead>
                  <TableHead>Partition</TableHead>
                  <TableHead>Start</TableHead>
                  <TableHead>End</TableHead>
                  <TableHead>Duration</TableHead>
                  <TableHead>Status</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {view.map(r => (
                  <TableRow key={r.id}>
                    <TableCell className="font-medium">{r.model}</TableCell>
                    <TableCell>{r.partition}</TableCell>
                    <TableCell>{new Date(r.start).toLocaleTimeString()}</TableCell>
                    <TableCell>{r.end ? new Date(r.end).toLocaleTimeString() : '—'}</TableCell>
                    <TableCell>{formatHM(r.durM)}</TableCell>
                    <TableCell><StatusBadge status={r.status}/></TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
