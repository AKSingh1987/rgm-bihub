<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AAS Refresh Monitor – Lite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- React & Babel (no build step) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body{font-family:system-ui, Segoe UI, Roboto, Arial;background:#f8fafc;color:#0f172a;margin:0}
      button{background:#2563eb;color:#fff;border:1px solid #2563eb;padding:8px 10px;border-radius:10px;cursor:pointer}
      button+button{margin-left:8px}
      button:hover{filter:brightness(.98)}
      th, td{padding:10px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:13px}
    </style>
    <script>
      // EDIT THIS to your tunnel URL (Step 2)
      window.API_BASE = "https://YOUR-TUNNEL.example.com";
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- Your React app (JSX compiled by Babel in the browser) -->
    <script type="text/babel">
      const {useEffect, useMemo, useRef, useState} = React;

      // --- helper fns (JS, no TS types) ---
      const minutesSinceStartOfDay = (s) => { const d=new Date(s); return d.getHours()*60+d.getMinutes()+d.getSeconds()/60; };
      const durationMinutes = (a,b) => { const s=new Date(a).getTime(); const e=b?new Date(b).getTime():s; return Math.max(0,(e-s)/60000); };
      const formatHM = (m) => { const M=Math.floor(m), S=Math.round((m-M)*60); return String(M).padStart(2,"0")+":"+String(S).padStart(2,"0"); };
      const toCSV = (rows) => {
        const headers=["Model","Partition","Type","Start","End","Duration","Status","RequestedBy","Priority"];
        const esc=(v)=>'"'+String(v ?? "").replaceAll('"','""')+'"';
        const lines=rows.map(r=>[
          r.model,r.partition,r.type||"Scheduled",r.start,r.end||"",
          formatHM(r.durM ?? durationMinutes(r.start,r.end)),
          r.status,r.requestedBy||"system",r.priority||"Medium"
        ].map(esc).join(","));
        return [headers.join(","), ...lines].join("\n");
      };

      // --- small UI bits ---
      const kpiCardStyle={background:"#fff",padding:12,border:"1px solid #e5e7eb",borderRadius:14,boxShadow:"0 1px 2px rgba(0,0,0,.04)",display:"flex",flexDirection:"column",gap:4};
      const inputStyle={padding:"8px 10px",border:"1px solid #cbd5e1",borderRadius:10,background:"#fff"};
      const cardStyle={background:"#fff",padding:12,border:"1px solid #e5e7eb",borderRadius:14,boxShadow:"0 1px 2px rgba(0,0,0,.04)"};
      const rowStyle={display:"flex",gap:8,flexWrap:"wrap",alignItems:"flex-end"};
      const tableStyle={width:"100%",borderCollapse:"collapse",background:"#fff",border:"1px solid #e5e7eb",borderRadius:14};
      const badgeStyle={padding:"2px 8px",borderRadius:999,border:"1px solid #cbd5e1",fontSize:12,display:"inline-block"};
      const styles={s:{color:"#065f46",background:"#ecfdf5",borderColor:"#a7f3d0"},f:{color:"#991b1b",background:"#fef2f2",borderColor:"#fecaca"},p:{color:"#92400e",background:"#fffbeb",borderColor:"#fde68a"},q:{color:"#1e40af",background:"#eff6ff",borderColor:"#bfdbfe"},u:{color:"#3730a3",background:"#eef2ff",borderColor:"#c7d2fe"}};

      const Kpi = ({label,value,subtitle}) => (
        <div style={kpiCardStyle}>
          <div style={{fontSize:12,color:"#64748b"}}>{label}</div>
          <div style={{fontSize:28,fontWeight:800,lineHeight:1}}>{value}</div>
          {subtitle ? <div style={{fontSize:12,color:"#94a3b8"}}>{subtitle}</div> : null}
        </div>
      );

      function App(){
        const [server, setServer] = useState(localStorage.getItem("aas.server") || "");
        const [db, setDb] = useState(localStorage.getItem("aas.db") || "");
        const [rows, setRows] = useState([]);
        const [query, setQuery] = useState("");
        const [statusFilter, setStatusFilter] = useState("all");
        const [auto, setAuto] = useState(false);
        const timerRef = useRef(null);
        const [logs, setLogs] = useState("");
        const [tab, setTab] = useState("scheduled");

        const log=(...a)=>setLogs(prev=>prev + a.join(" ") + "\n");

        const filtered = useMemo(()=>{
          const q=query.trim().toLowerCase();
          return rows.filter(r=>{
            const hay = `${r.model} ${r.partition} ${r.type} ${r.status} ${r.requestedBy}`.toLowerCase();
            if(q && !hay.includes(q)) return false;
            if(statusFilter!=="all" && r.status!==statusFilter) return false;
            return true;
          });
        },[rows,query,statusFilter]);

        const kTotal=filtered.length;
        const kPending=filtered.filter(r=>r.type==="Adhoc" && r.status!=="Success").length;
        const kDone=filtered.filter(r=>(r.type||"Scheduled")==="Scheduled" && r.status==="Success").length;
        const kFailed=filtered.filter(r=>r.status==="Failed").length;

        const API = (path, init) => fetch(`${window.API_BASE}${path}`, init);

        async function authPing(){
          try{
            const r = await API("/api/auth/ping");
            const txt = await r.text();
            log("Auth:", txt);
            if(!r.ok) alert("Auth issue: " + txt);
          }catch(e){ log("Auth ping error:", String(e)); alert("Auth ping error: " + e); }
        }

        async function load(){
          if(!server || !db){ alert("Enter server & database first"); return; }
          try{
            const res = await API(`/api/aas/refreshes?server=${encodeURIComponent(server)}&db=${encodeURIComponent(db)}`);
            if(!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const next = (data.rows || []).map(r=>({
              ...r,
              startM: minutesSinceStartOfDay(r.start),
              durM: durationMinutes(r.start, r.end ?? null),
            }));
            setRows(next);
          }catch(e){ log("Load error:", String(e)); alert("Failed to load: " + e); }
        }

        async function submit(){
          const body = {
            server,
            database: db,
            type: document.getElementById("rqType")?.value || "Adhoc",
            mode: document.getElementById("rqMode")?.value || "full",
            model: document.getElementById("rqModel")?.value || "",
            table: document.getElementById("rqTable")?.value || null,
            partition: document.getElementById("rqPart")?.value || "",
            requestedBy: document.getElementById("rqBy")?.value || "",
            priority: document.getElementById("rqPriority")?.value || "Medium",
            notes: document.getElementById("rqNotes")?.value || "",
          };
          if(!body.model || !body.partition || !body.requestedBy){ alert("Fill Model, Partition, Requested By"); return; }
          try{
            const res = await API("/api/aas/submit",{ method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body) });
            if(!res.ok) throw new Error(await res.text());
            log("Submit ok");
            await load();
          }catch(e){ log("Submit error:", String(e)); alert("Failed to submit: " + e); }
        }

        function exportCSV(){
          const csv = toCSV(rows);
          const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href=url; a.download="aas_refreshes.csv"; a.click();
          URL.revokeObjectURL(url);
        }

        function runTests(){
          const t=[];
          const eq=(n,a,e)=>t.push(`${(Number.isNaN(e)&&Number.isNaN(a))||a===e ? "✔":"✖"} ${n}: ${String(a)} ${a===e?"==":"!="} ${String(e)}`);
          eq("duration 30", ((new Date("2025-09-17T10:30:00")-new Date("2025-09-17T10:00:00"))/60000), 30);
          eq("formatHM 12.5",""+formatHM(12.5),"12:30");
          eq("CSV header only", toCSV([]).split("\n").length, 1);
          setLogs(prev=>prev + t.join("\n") + "\n");
          alert("Tests complete. See Debug / Logs.");
        }

        useEffect(()=>{
          if(auto){
            const id = setInterval(load, 15000);
            timerRef.current = id;
            return ()=>{ clearInterval(id); timerRef.current=null; };
          }
        },[auto,server,db]);

        const TabBar = () => {
          const item=(k,label)=>(
            <button onClick={()=>setTab(k)} style={{background:tab===k?"#1d4ed8":"#fff",color:tab===k?"#fff":"#0f172a",border:"1px solid #cbd5e1",padding:"8px 12px",borderRadius:10}}>{label}</button>
          );
          return <div style={{display:"flex",gap:8,marginTop:12}}>{item("scheduled","Scheduled Refreshes")}{item("adhoc","Adhoc Request")}{item("new","New Request")}</div>;
        };

        const SubmitForm = ({kind}) => (
          <div style={cardStyle}>
            <h3>Submit {kind} Request</h3>
            <div style={rowStyle}>
              <label>Type
                <select id="rqType" style={inputStyle} defaultValue={kind} disabled>
                  <option>Adhoc</option><option>New</option>
                </select>
              </label>
              <label>Mode
                <select id="rqMode" style={inputStyle} defaultValue="full">
                  <option value="full">Full</option>
                  <option value="dataOnly">Data Only</option>
                  <option value="calculate">Recalc</option>
                  <option value="clearValues">Clear Values</option>
                </select>
              </label>
            </div>
            <div style={rowStyle}>
              <label>Model <input id="rqModel" placeholder="NRM_Global" style={inputStyle}/></label>
              <label>Table <input id="rqTable" placeholder="(optional)" style={inputStyle}/></label>
              <label>Partition <input id="rqPart" placeholder="IN_Bev" style={inputStyle}/></label>
            </div>
            <div style={rowStyle}>
              <label>Priority
                <select id="rqPriority" style={inputStyle} defaultValue="Medium">
                  <option>Low</option><option>Medium</option><option>High</option>
                </select>
              </label>
              <label>Requested By <input id="rqBy" placeholder="name or email" style={inputStyle}/></label>
              <label>Notes <input id="rqNotes" placeholder="ticket, purpose" style={inputStyle}/></label>
            </div>
            <div style={rowStyle}><button onClick={submit}>Submit</button></div>
          </div>
        );

        return (
          <div>
            <header style={{position:"sticky",top:0,background:"#fff",borderBottom:"1px solid #e5e7eb",padding:10,display:"flex",gap:8,alignItems:"center"}}>
              <div style={{background:"#2563eb",color:"#fff",width:36,height:36,display:"grid",placeItems:"center",borderRadius:10,fontWeight:700}}>NRM</div>
              <strong>AAS Refresh Monitor - Lite</strong>
              <div style={{marginLeft:"auto",display:"flex",gap:8}}>
                <button onClick={authPing}>Sign In</button>
                <button onClick={runTests}>Run Tests</button>
                <button onClick={exportCSV}>Export CSV</button>
              </div>
            </header>

            <main style={{maxWidth:1100,margin:"0 auto",padding:16}}>
              <section style={cardStyle}>
                <h3>Connect</h3>
                <div style={rowStyle}>
                  <label>Server
                    <input value={server} onChange={(e)=>setServer(e.target.value)} size="48" placeholder="asazure://<region>.asazure.windows.net/<server-name>" style={inputStyle}/>
                  </label>
                  <label>Database
                    <input value={db} onChange={(e)=>setDb(e.target.value)} size="18" placeholder="NRM_Global" style={inputStyle}/>
                  </label>
                  <button onClick={async ()=>{
                    localStorage.setItem("aas.server", server.trim());
                    localStorage.setItem("aas.db", db.trim());
                    alert("Saved connection. Loading...");
                    await authPing();
                    await load();
                  }}>Save & Load</button>
                  <button onClick={()=>setAuto(v=>!v)} style={{background:"#fff",color:"#0f172a",border:"1px solid #cbd5e1",borderRadius:10,padding:"8px 10px"}}>
                    {`Live: ${auto ? "On" : "Off"}`}
                  </button>
                </div>
                <div style={{color:"#64748b",fontSize:12}}>{server && db ? `Connected: ${server} / ${db}` : "Not connected"}</div>
                <div style={{color:"#64748b",fontSize:12}}>Tip: If no browser prompt appears, click <em>Sign In</em>. If a device code prints in the server console, open https://microsoft.com/devicelogin and enter it.</div>
                <TabBar />
              </section>

              <section style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,margin:"16px 0"}}>
                <Kpi label="Total Items" value={filtered.length}/>
                <Kpi label="Pending Adhoc" value={kPending}/>
                <Kpi label="Scheduled Done" value={kDone}/>
                <Kpi label="Failed" value={kFailed}/>
              </section>

              {tab==="adhoc" && <SubmitForm kind="Adhoc" />}
              {tab==="new" && <SubmitForm kind="New" />}
              {tab==="scheduled" && (
                <>
                  <section style={cardStyle}>
                    <h3>Filters</h3>
                    <div style={rowStyle}>
                      <input value={query} onChange={(e)=>setQuery(e.target.value)} size="40" placeholder="Search model / partition / user" style={inputStyle}/>
                      <select value={statusFilter} onChange={(e)=>setStatusFilter(e.target.value)} style={inputStyle}>
                        <option value="all">All Status</option>
                        <option>Success</option><option>Failed</option><option>In Progress</option><option>Queued</option><option>Submitted</option>
                      </select>
                    </div>
                  </section>
                  <section style={{...cardStyle, marginTop:16}}>
                    <h3>Refresh Status</h3>
                    <div style={{overflow:"auto"}}>
                      <table style={tableStyle}>
                        <thead>
                          <tr><th>Model</th><th>Market / Partition</th><th>Type</th><th>Start</th><th>End</th><th>Duration</th><th>Status</th><th>Requested By</th><th>Priority</th></tr>
                        </thead>
                        <tbody>
                          {filtered.map((r,i)=>{
                            const cls=r.status==="Success"?styles.s:r.status==="Failed"?styles.f:r.status==="Queued"?styles.q:r.status==="Submitted"?styles.u:styles.p;
                            return (
                              <tr key={i}>
                                <td>{r.model}</td>
                                <td>{r.partition}</td>
                                <td><span style={badgeStyle}>{r.type||"Scheduled"}</span></td>
                                <td>{new Date(r.start).toLocaleTimeString()}</td>
                                <td>{r.end?new Date(r.end).toLocaleTimeString():"—"}</td>
                                <td>{formatHM(r.durM ?? 0)}</td>
                                <td><span style={{...badgeStyle,...cls}}>{r.status}</span></td>
                                <td>{r.requestedBy||"system"}</td>
                                <td>{r.priority||"Medium"}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </section>
                </>
              )}

              <details style={cardStyle}><summary>Debug / Logs</summary><pre style={{whiteSpace:"pre-wrap"}}>{logs}</pre></details>
            </main>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
