import React from 'react';


export default function GlobalRGMHub() {
  // ---------- Storage helpers ----------
  const getLS = (k, def) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; } };
  const setLS = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

  // ---------- Theme & settings ----------
  const [dark, setDark] = React.useState(getLS('hub.dark', false));
  const [apiBase, setApiBase] = React.useState(getLS('hub.api', ''));

  React.useEffect(() => {
    document.documentElement.classList.toggle('dark', !!dark);
    setLS('hub.dark', !!dark);
  }, [dark]);
  React.useEffect(() => { setLS('hub.api', apiBase); }, [apiBase]);

  // ---------- Seeds / Data ----------
  const seedRefreshes = [
    { id: 'r1', model: 'DS_MKT_SHR_SLS_C2', partition: 'PN282', status: 'Pending Approval', approver: '', requestedBy: 'Ops', reason: 'Manual rerun', start: null, end: null, durationMin: null },
    { id: 'r2', model: 'DS_MKT_SHR_SLS_C2', partition: 'PN276', status: 'Succeeded', approver: '—', requestedBy: 'Sched', reason: '—', start: '2025-09-08 01:30', end: '2025-09-08 01:46', durationMin: 16 },
  ];
  const seedQC = [
    { id: 'qc1', model: 'DS_MKT_SHR_SLS_C1', market: 'Snacks', country: 'India', sourceVal: 125000, aasVal: 124500 },
    { id: 'qc2', model: 'DS_MKT_SHR_SLS_C2', market: 'Beverages', country: 'Mexico', sourceVal: 98000, aasVal: 98200 },
  ];

  const [refreshes, setRefreshes] = React.useState(getLS('hub.refreshes', seedRefreshes));
  const [qc, setQC] = React.useState(getLS('hub.qc', seedQC));
  const [tab, setTab] = React.useState('overview');

  React.useEffect(() => { setLS('hub.refreshes', refreshes); }, [refreshes]);
  React.useEffect(() => { setLS('hub.qc', qc); }, [qc]);

  // ---------- Small UI primitives ----------
  const css = `
    :root{--bg:#f7f7f9;--card:#fff;--text:#0f172a;--muted:#475569;--line:#e5e7eb;--chip:#eef2ff;--chipText:#3730a3}
    .dark{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#cbd5e1;--line:#1f2937;--chip:#0b3b47;--chipText:#93c5fd}
    html,body,#root{height:100%}
    .wrap{max-width:1150px;margin:24px auto;padding:0 16px;background:var(--bg);color:var(--text)}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{margin:0;font-weight:700;font-size:22px}
    .right{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border:1px solid var(--line);background:var(--card);border-radius:10px;cursor:pointer;color:var(--text)}
    .input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);min-width:260px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chipText);padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:768px){.grid-3{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h3{margin:0 0 8px;font-size:18px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    thead{background:rgba(148,163,184,.15)}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border:1px solid var(--line);background:var(--card);border-radius:10px;cursor:pointer}
    .tab.active{background:rgba(148,163,184,.15)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .danger{color:#dc2626}
    .success{color:#059669}
  `;

  const Card = ({ title, extra, children }) => (
    <div className="card">
      <div className="row" style={{alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
        <h3>{title}</h3>
        {extra || null}
      </div>
      <div>{children}</div>
    </div>
  );

  const Stat = ({ label, value }) => (
    <div className="card">
      <div className="muted" style={{fontSize:12}}>{label}</div>
      <div style={{fontWeight:700,fontSize:20,marginTop:4}}>{value}</div>
    </div>
  );

  // ---------- Tabs ----------
  const TABS = [
    { key: 'overview', label: 'Overview' },
    { key: 'ops', label: 'Ops Health' },
    { key: 'qc', label: 'QC Check' },
    { key: 'refreshes', label: 'Refreshes (Approve)' },
    { key: 'intake', label: 'Work Intake (Approve)' },
    { key: 'infra', label: 'Infra Mgmt' },
  ];

  // ---------- Sections ----------
  const Overview = () => {
    const success = refreshes.filter(r=>r.status==='Succeeded').length;
    const total = refreshes.length;
    const successRate = total ? Math.round((success/total)*100) : 0;
    const qcFailures = qc.filter(r => ((r.aasVal ?? 0) - (r.sourceVal ?? 0)) !== 0).length; // non-zero diff = failure
    return (
      <div>
        <div className="grid grid-3">
          <Stat label="Refresh Success %" value={`${successRate}%`} />
          <Stat label="Velocity (sample)" value={85} />
          <Stat label="QC Failures" value={qcFailures} />
        </div>
        <Card title="Quick Notes">
          <p className="muted">Use the tabs for Ops Health, QC comparisons (TD/UC vs AAS), approvals, and infra cost tracking.</p>
        </Card>
      </div>
    );
  };

  const OpsHealth = () => {
    const runs = refreshes.slice().reverse().slice(0, 20);
    const median = (arr)=>{ if(!arr.length) return 0; const s=arr.slice().sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2 };
    const medDur = median(refreshes.map(r=>r.durationMin||0));
    const failures = refreshes.filter(r=>r.status==='Failed');
    return (
      <div>
        <div className="grid grid-3">
          <Stat label="Runs (total)" value={refreshes.length} />
          <Stat label="Median Duration" value={`${medDur} min`} />
          <Stat label="Failures (sample)" value={failures.length} />
        </div>
        <Card title="Last 20 Runs">
          <div style={{overflowX:'auto'}}>
            <table>
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Partition</th>
                  <th>Status</th>
                  <th style={{textAlign:'right'}}>Duration</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                {runs.map(r => (
                  <tr key={r.id}>
                    <td>{r.model}</td>
                    <td>{r.partition}</td>
                    <td>{r.status==='Failed' ? <span className="pill danger" style={{borderColor:'#fecaca'}}>Failed</span> : <span className="pill success" style={{borderColor:'#bbf7d0'}}>{r.status}</span>}</td>
                    <td style={{textAlign:'right'}}>{r.durationMin ?? '—'}</td>
                    <td>{r.reason || '—'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      </div>
    );
  };

  const QCSection = () => {
    const [busy, setBusy] = React.useState(false);
    const runQC = async () => {
      const base = apiBase || getLS('hub.api', '');
      if (!base){ alert('Set API Base URL (top-right).'); return; }
      try{
        setBusy(true);
        const res = await fetch(base + '/api/qc/compare');
        if (!res.ok) throw new Error('HTTP '+res.status);
        const rows = await res.json();
        const mapped = (rows||[]).map(r => ({ ...r, id:`${r.model}-${r.market}-${r.country}` }));
        setQC(mapped);
      }catch(err){ console.error(err); alert('QC fetch failed'); }
      finally{ setBusy(false); }
    };
    const failuresOnly = qc.filter(r => ((r.aasVal ?? 0) - (r.sourceVal ?? 0)) !== 0);
    return (
      <div>
        <div className="right" style={{marginBottom:8}}>
          <button className="btn" onClick={runQC} disabled={busy}>{busy? 'Running…' : 'Run QC (live)'}</button>
          <span className="muted">Failures: {failuresOnly.length} / {qc.length}</span>
        </div>
        <Card title="QC Results – TD/UC vs AAS">
          <div style={{overflowX:'auto'}}>
            <table>
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Market</th>
                  <th>Country</th>
                  <th style={{textAlign:'right'}}>Source (TD/UC)</th>
                  <th style={{textAlign:'right'}}>AAS</th>
                  <th>Status</th>
                  <th style={{textAlign:'right'}}>Diff</th>
                </tr>
              </thead>
              <tbody>
                {qc.map(r => {
                  const diff = (r.aasVal ?? 0) - (r.sourceVal ?? 0);
                  const fail = diff !== 0; // non-zero = failure
                  return (
                    <tr key={r.id}>
                      <td>{r.model}</td>
                      <td>{r.market}</td>
                      <td>{r.country}</td>
                      <td style={{textAlign:'right'}}>{r.sourceVal}</td>
                      <td style={{textAlign:'right'}}>{r.aasVal}</td>
                      <td>{fail ? <span className="pill danger" style={{borderColor:'#fecaca'}}>Fail</span> : <span className="pill success" style={{borderColor:'#bbf7d0'}}>Pass</span>}</td>
                      <td style={{textAlign:'right', color: fail ? '#dc2626' : undefined }}>{diff}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </Card>
      </div>
    );
  };

  const Refreshes = () => {
    const [form, setForm] = React.useState({ model:'', partition:'', requestedBy:'', reason:'' });
    const submit = () => {
      if (!form.model || !form.partition || !form.requestedBy){ alert('Model, Partition, Requested By are required'); return; }
      const row = { id: Math.random().toString(36).slice(2,9), status:'Pending Approval', approver:'', start:null, end:null, durationMin:null, ...form };
      setRefreshes([row, ...refreshes]); setForm({ model:'', partition:'', requestedBy:'', reason:'' });
    };
    const approve = (id) => setRefreshes(refreshes.map(r=> r.id===id ? { ...r, status:'Approved', approver: prompt('Approver name', 'Lead') || 'Lead' } : r));
    const reject = (id) => setRefreshes(refreshes.map(r=> r.id===id ? { ...r, status:'Rejected', approver: prompt('Approver name', 'Lead') || 'Lead' } : r));
    return (
      <div>
        <Card title="New Refresh Request">
          <div className="row">
            <div className="col"><div>Model</div><input className="input" value={form.model} onChange={e=>setForm({...form, model:e.target.value})} /></div>
            <div className="col"><div>Partition</div><input className="input" value={form.partition} onChange={e=>setForm({...form, partition:e.target.value})} /></div>
            <div className="col"><div>Requested By</div><input className="input" value={form.requestedBy} onChange={e=>setForm({...form, requestedBy:e.target.value})} /></div>
            <div className="col" style={{flex:'2 1 420px'}}><div>Reason</div><input className="input" value={form.reason} onChange={e=>setForm({...form, reason:e.target.value})} /></div>
          </div>
          <div style={{marginTop:8}}><button className="btn" onClick={submit}>Submit</button></div>
        </Card>
        <Card title="Refresh Requests">
          <div style={{overflowX:'auto'}}>
            <table>
              <thead>
                <tr>
                  <th>Model</th><th>Partition</th><th>Requested By</th><th>Status</th><th>Approver</th><th>Reason</th><th style={{textAlign:'right'}}>Actions</th>
                </tr>
              </thead>
              <tbody>
                {refreshes.map(r => (
                  <tr key={r.id}>
                    <td>{r.model}</td>
                    <td>{r.partition}</td>
                    <td>{r.requestedBy}</td>
                    <td>{r.status}</td>
                    <td>{r.approver || '—'}</td>
                    <td>{r.reason || '—'}</td>
                    <td style={{textAlign:'right'}}>
                      {r.status==='Pending Approval' && (<>
                        <button className="btn" onClick={()=>approve(r.id)}>Approve</button>{' '}
                        <button className="btn" onClick={()=>reject(r.id)}>Reject</button>
                      </>)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      </div>
    );
  };

  const Intake = () => {
    const [list, setList] = React.useState(getLS('hub.intake', [ { id:'w1', title:'Add Belgium Price Tier', status:'Pending Approval', requestedBy:'Analyst1', approver:'' } ]));
    React.useEffect(()=> setLS('hub.intake', list), [list]);
    const [form, setForm] = React.useState({ title:'', requestedBy:'' });
    const submit = () => { if (!form.title||!form.requestedBy) return alert('Title and Requested By required'); setList([{ id:Math.random().toString(36).slice(2,9), status:'Pending Approval', approver:'', ...form }, ...list]); setForm({ title:'', requestedBy:'' }); };
    const approve = (id) => setList(list.map(i=> i.id===id ? { ...i, status:'Approved', approver: prompt('Approver name','Lead') || 'Lead' } : i));
    const reject = (id) => setList(list.map(i=> i.id===id ? { ...i, status:'Rejected', approver: prompt('Approver name','Lead') || 'Lead' } : i));
    return (
      <div>
        <Card title="New Work Intake">
          <div className="row">
            <div className="col" style={{flex:'2 1 420px'}}><div>Title</div><input className="input" value={form.title} onChange={e=>setForm({...form, title:e.target.value})} /></div>
            <div className="col"><div>Requested By</div><input className="input" value={form.requestedBy} onChange={e=>setForm({...form, requestedBy:e.target.value})} /></div>
          </div>
          <div style={{marginTop:8}}><button className="btn" onClick={submit}>Submit</button></div>
        </Card>
        <Card title="Work Intake Requests">
          <div style={{overflowX:'auto'}}>
            <table>
              <thead><tr><th>Title</th><th>Requested By</th><th>Status</th><th>Approver</th><th style={{textAlign:'right'}}>Actions</th></tr></thead>
              <tbody>
                {list.map(i => (
                  <tr key={i.id}>
                    <td>{i.title}</td><td>{i.requestedBy}</td><td>{i.status}</td><td>{i.approver || '—'}</td>
                    <td style={{textAlign:'right'}}>{i.status==='Pending Approval' && (<>
                      <button className="btn" onClick={()=>approve(i.id)}>Approve</button>{' '}
                      <button className="btn" onClick={()=>reject(i.id)}>Reject</button>
                    </>)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      </div>
    );
  };

  const Infra = () => {
    const [monthly, setMonthly] = React.useState(getLS('hub.infra.monthly', [ { month:'2025-01', cost:8200 }, { month:'2025-02', cost:8400 } ]));
    React.useEffect(()=> setLS('hub.infra.monthly', monthly), [monthly]);
    const fmtMoney = n => '$'+Math.round((Number(n)||0)).toLocaleString();
    const yyyy = new Date().getFullYear()+'';
    const thisYear = monthly.filter(r=>String(r.month).startsWith(yyyy+'-')).sort((a,b)=>String(a.month).localeCompare(String(b.month)));
    const ytd = thisYear.reduce((a,b)=> a + (Number(b.cost)||0), 0);
    const last = thisYear[thisYear.length-1]?.cost || 0;
    const last3 = thisYear.slice(-3).map(d=>Number(d.cost)||0);
    const avg3 = last3.length ? (last3.reduce((a,b)=>a+b,0)/last3.length) : (ytd/Math.max(1,thisYear.length));
    const forecast = Math.round((ytd + avg3 * Math.max(0, 12 - thisYear.length)) * 100)/100;

    const parseCSV = async (file) => {
      const txt = await file.text();
      const lines = txt.split(/\r?\n/).filter(Boolean);
      if (!lines.length) return alert('Empty CSV');
      const headers = lines[0].split(',').map(h=>h.trim());
      const rows = lines.slice(1).map(line => {
        const cells = line.split(','); const o={}; headers.forEach((h,i)=>{ const raw=(cells[i]||'').trim(); const num=Number(raw); o[h]=Number.isFinite(num)&&raw!==''?num:raw; }); return o;
      });
      if (!('month' in rows[0]) || !('cost' in rows[0])) return alert('CSV must have headers: month,cost');
      const cleaned = rows.map(r=> ({ month:String(r.month), cost:Number(r.cost)||0 }));
      setMonthly(cleaned);
    };

    const exportCSV = () => {
      const header = 'month,cost\n';
      const body = monthly.map(r=>`${r.month},${r.cost}`).join('\n');
      const blob = new Blob([header+body], { type:'text/csv' });
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='MonthlyCosts.csv'; a.click(); URL.revokeObjectURL(url);
    };

    return (
      <div>
        <div className="grid grid-3">
          <Stat label="YTD Cost" value={fmtMoney(ytd)} />
          <Stat label="Run Rate (Last)" value={fmtMoney(last)} />
          <Stat label="Forecast (FY)" value={fmtMoney(forecast)} />
        </div>
        <Card title="Upload / Export">
          <div className="row">
            <div className="col"><div>Upload CSV (month,cost)</div><input type="file" className="input" accept=".csv" onChange={ev=>{ const f=ev.target.files?.[0]; if(f) parseCSV(f); }} /></div>
            <div className="col" style={{display:'flex',alignItems:'flex-end'}}><button className="btn" onClick={exportCSV}>Export current CSV</button></div>
          </div>
        </Card>
        <Card title="Raw Data">
          <div style={{overflowX:'auto'}}>
            <table>
              <thead><tr><th>Month</th><th style={{textAlign:'right'}}>Cost</th></tr></thead>
              <tbody>
                {monthly.map((r,i)=> (
                  <tr key={r.month+'-'+i}><td>{r.month}</td><td style={{textAlign:'right'}}>{fmtMoney(r.cost)}</td></tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      </div>
    );
  };

  // ---------- Runtime self-checks (simple tests) ----------
  React.useEffect(() => {
    try {
      // QC rule: non-zero diff = failure
      const A = { sourceVal: 100, aasVal: 100 };
      const B = { sourceVal: 90, aasVal: 100 };
      console.assert((A.aasVal - A.sourceVal) === 0, 'QC Test A failed');
      console.assert((B.aasVal - B.sourceVal) === 10, 'QC Test B failed');

      // Forecast sanity (Infra)
      const y = new Date().getFullYear();
      const s3 = [ {month:`${y}-01`, cost:100}, {month:`${y}-02`, cost:200}, {month:`${y}-03`, cost:300} ];
      const ytd3 = s3.reduce((a,b)=>a+b.cost,0);
      const avg3 = (100+200+300)/3; const rem = 12 - 3;
      const f = Math.round((ytd3 + avg3*rem)*100)/100;
      console.assert(ytd3 === 600, 'YTD should be 600');
      console.assert(f === 2400, 'Forecast should be 2400');

      // Extra test: CSV parse tolerant to CRLF & LF
      const parseQuick = (txt)=>{ const lines = txt.split(/\r?\n/).filter(Boolean); const head = lines[0].split(','); const r = lines[1].split(','); return { [head[0]]: r[0], [head[1]]: Number(r[1]) }; };
      const rowLF = parseQuick('month,cost\n2025-01,10');
      const rowCRLF = parseQuick('month,cost\r\n2025-01,10');
      console.assert(rowLF.cost === 10 && rowCRLF.cost === 10, 'CSV newline parsing failed');
    } catch (e) {
      console.warn('Self-checks failed:', e);
    }
  }, []);

  // ---------- Render ----------
  return (
    <div className="wrap">
      <style>{css}</style>
      <div className="toolbar">
        <div className="row" style={{alignItems:'center'}}>
          <h1 className="title">Global RGM BI Hub</h1>
          <span className="chip">Embed-friendly</span>
        </div>
        <div className="right">
          <input className="input" placeholder="API Base URL (optional)" value={apiBase} onChange={e=>setApiBase(e.target.value)} />
          <button className="btn" onClick={()=>setDark(d=>!d)}>{dark? 'Light' : 'Dark'}</button>
        </div>
      </div>

      <div className="tabs">
        {TABS.map(t => (
          <button key={t.key} className={"tab" + (tab===t.key ? " active" : "")} onClick={()=>setTab(t.key)}>{t.label}</button>
        ))}
      </div>

      {tab==='overview' && <Overview/>}
      {tab==='ops' && <OpsHealth/>}
      {tab==='qc' && <QCSection/>}
      {tab==='refreshes' && <Refreshes/>}
      {tab==='intake' && <Intake/>}
      {tab==='infra' && <Infra/>}
    </div>
  );
}
